<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>L.3 - Vocabulary & Listening</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>L.3 - Vocabulary & Listening</h1>
  <p id="usernameDisplay"></p>

  <!-- Vocabulary Quiz Section -->
  <section id="vocab-quiz-section">
    <div id="quiz-container"></div>
    <button id="nextBtn" style="display:none;">Next</button>
    <p id="result"></p>
  </section>

  <!-- Listening Quiz Section (hidden by default) -->
  <section id="listening-quiz-section" style="display:none;">
    <div id="listening-container"></div>
    <input id="dictationInput" type="text" placeholder="Type the missing word...">
    <button id="replayAudio">ðŸ”ˆ</button>
    <button id="checkDictation">Check</button>
    <p id="dictationResult"></p>
  </section>

<script>
const username = localStorage.getItem("username") || "Guest";
document.getElementById("usernameDisplay").textContent = `Logged in as: ${username}`;

function shuffle(array) {
  return array.map(value => ({ value, sort: Math.random() }))
              .sort((a, b) => a.sort - b.sort)
              .map(({ value }) => value);
}

// --- Vocabulary Quiz ---
const allVocabQuestions = [
  { question: "Choose the correct meaning of 'wrap'", options: ["ï½žã‚’å–ã‚Šæ›¿ãˆã‚‹", "ï½žã‚’åŒ…ã‚€", "ï½žã‚’æŠ•ã’ã‚‹", "ï½žã‚’è‚²ã¦ã‚‹"], answer: 1 },
  { question: "Choose the correct meaning of 'ban'", options: ["ã€œã‚’ç¦æ­¢ã™ã‚‹", "ã€œã‚’ç¥ã†", "ã€œã‚’ä¿å­˜ã™ã‚‹", "ã€œã‚’å¥¨åŠ±ã™ã‚‹"], answer: 0 },
];
let vocabQuestions = shuffle([...allVocabQuestions]);
let current = 0;
let incorrectQuestions = [];
let score = 0, incorrect = 0, answered = false;
let startTime = Date.now();
let firstAttemptScore = null;
let perfectAchieved = false;
let perfectTimeSec = 0;

const container = document.getElementById("quiz-container");
const resultBox = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");

nextBtn.addEventListener("click", nextQuestion);

function showVocabQuestion() {
  answered = false;
  const q = vocabQuestions[current];
  const shuffledOptions = shuffle(q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.answer })));

  container.innerHTML = `
    <div class="question">
      <strong>Q${current + 1}: ${q.question}</strong><br>
      ${shuffledOptions.map(opt => `<button data-correct="${opt.isCorrect}" class="option-button">${opt.text}</button>`).join('')}
    </div>
  `;

  resultBox.textContent = "";
  nextBtn.style.display = "none";

  document.querySelectorAll(".option-button").forEach(button => {
    button.addEventListener("click", () => {
      if (answered) return;
      answered = true;
      const isCorrect = button.dataset.correct === "true";
      if (isCorrect) {
        score++;
        resultBox.textContent = "âœ… Correct!";
      } else {
        incorrect++;
        resultBox.textContent = "âŒ Incorrect.";
        incorrectQuestions.push(q);
      }
      document.querySelectorAll(".option-button").forEach(btn => btn.disabled = true);
      nextBtn.style.display = "inline-block";
    });
  });
}

function nextQuestion() {
  current++;
  if (current < vocabQuestions.length) {
    showVocabQuestion();
  } else {
    finishVocabQuiz();
  }
}

function finishVocabQuiz() {
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  const initialScorePercent = Math.round((score / (score + incorrect)) * 100);
  if (firstAttemptScore === null) {
    firstAttemptScore = initialScorePercent;
    localStorage.setItem(`${username}_vocab_score`, initialScorePercent);
  }
  if (incorrectQuestions.length === 0) {
    if (!perfectAchieved) {
      perfectAchieved = true;
      perfectTimeSec = elapsedSec;
      localStorage.setItem(`${username}_vocab_time`, perfectTimeSec);
    }
    document.getElementById("vocab-quiz-section").style.display = "none";
    startListeningQuiz();
  } else {
    alert("Some answers were wrong. Retrying those questions.");
    vocabQuestions = shuffle([...incorrectQuestions]);
    incorrectQuestions = [];
    current = 0;
    score = 0;
    incorrect = 0;
    startTime = Date.now();
    showVocabQuestion();
  }
}

// --- Listening Quiz ---
// âœ… Listeningå•é¡Œã®å‡ºé¡Œé †ãƒ©ãƒ³ãƒ€ãƒ åŒ– & é–“é•ã„ã¯ã‚„ã‚Šç›´ã—æ–¹å¼ & æ­£è§£æ™‚ã«âœ…è¡¨ç¤º
let allListeningQuestions = [
  {
    sentence: "She used colorful paper to wrap the present.",
    display: "She used colorful paper to ______ the present.",
    answer: "wrap"
  },
  {
    sentence: "Each cookie was individually wrapped to keep it fresh.",
    display: "Each cookie was ______ wrapped to keep it fresh.",
    answer: "individually"
  },
  {
    sentence: "The documents were placed in a safe storage area.",
    display: "The documents were placed in a safe _____ area.",
    answer: "storage"
  },
  {
    sentence: "He showed great consideration for her feelings.",
    display: "He showed great ______ for her feelings.",
    answer: "consideration"
  },
  {
    sentence: "Her thoughtfulness made everyone feel welcome.",
    display: "Her _____ made everyone feel welcome.",
    answer: "thoughtfulness"
  },
  {
    sentence: "The wedding banquet was held in a large hall.",
    display: "The wedding _____ was held in a large hall.",
    answer: "banquet"
  },
  {
    sentence: "It is impolite to talk during a performance.",
    display: "It is _____ to talk during a performance.",
    answer: "impolite"
  },
  {
    sentence: "Please unwrap the gift carefully.",
    display: "Please _____ the gift carefully.",
    answer: "unwrap"
  },
  {
    sentence: "He is known for being warm-hearted and generous.",
    display: "He is known for being _____ and generous.",
    answer: "warm-hearted"
  },
  {
    sentence: "There is a growing interest in renewable energy.",
    display: "There is a _____ interest in renewable energy.",
    answer: "growing"
  },
  {
    sentence: "The school decided to restrict phone usage during classes.",
    display: "The school decided to _____ phone usage during classes.",
    answer: "restrict"
  },
  {
    sentence: "Smoking is banned in all public buildings.",
    display: "Smoking is _____ in all public buildings.",
    answer: "banned"
  }
];

let listeningQuestions = shuffle([...allListeningQuestions]);
let currentListening = 0;
let incorrectListeningQuestions = [];

function speak(text) { ... }

function startListeningQuiz() { ... }

function showListeningQuestion() { ... }

document.getElementById("replayAudio").addEventListener(...);

document.getElementById("checkDictation").addEventListener(...);


showVocabQuestion();
</script>
</body>
</html>