<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>L.3 - Vocabulary Quiz</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>L.3 - Vocabulary Course</h1>
  <p id="usernameDisplay"></p>

  <div id="quiz-container"></div>
  <button id="nextBtn" style="display:none;">Next</button>
  <p id="result"></p>

  <script type="module">
    const username = localStorage.getItem("username") || "Guest";
    document.getElementById("usernameDisplay").textContent = `Logged in as: ${username}`;

    const allQuestions = [
      {
        question: "What is the synonym of 'big'?",
        options: ["small", "huge", "thin", "quiet"],
        answer: 1
      },
      {
        question: "What is the antonym of 'happy'?",
        options: ["joyful", "excited", "sad", "smile"],
        answer: 2
      },
      {
        question: "Choose the correct spelling:",
        options: ["enviroment", "environment", "envirenment", "enviornment"],
        answer: 1
      }
    ];

    let current = 0;
    let questions = [...allQuestions];
    let incorrectQuestions = [];
    let score = 0;
    let incorrect = 0;
    let firstAttemptScore = null;
    let startTime = Date.now();
    let answered = false;

    const container = document.getElementById("quiz-container");
    const resultBox = document.getElementById("result");
    const nextBtn = document.getElementById("nextBtn");

    nextBtn.addEventListener("click", () => nextQuestion());

    function shuffle(array) {
      return array
        .map(value => ({ value, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ value }) => value);
    }

    function showQuestion() {
      answered = false;
      const q = questions[current];

      // 選択肢シャッフル + 正解インデックスの変換
      const originalOptions = q.options.map((opt, i) => ({
        text: opt,
        isCorrect: i === q.answer
      }));
      const shuffledOptions = shuffle(originalOptions);

      container.innerHTML = `
        <div class="question">
          <strong>Q${current + 1}: ${q.question}</strong><br>
          ${shuffledOptions.map((opt, i) =>
            `<button data-correct="${opt.isCorrect}" class="option-button">${opt.text}</button>`
          ).join("")}
        </div>
      `;

      resultBox.textContent = "";
      nextBtn.style.display = "none";

      document.querySelectorAll(".option-button").forEach(button => {
        button.addEventListener("click", () => {
          if (answered) return;
          answered = true;

          const isCorrect = button.dataset.correct === "true";
          if (isCorrect) {
            score++;
            resultBox.textContent = "✅ Correct!";
          } else {
            incorrect++;
            resultBox.textContent = "❌ Incorrect.";
            incorrectQuestions.push(q); // 間違えた問題を記録
          }

          document.querySelectorAll(".option-button").forEach(btn => btn.disabled = true);
          nextBtn.style.display = "inline-block";
        });
      });
    }

    function nextQuestion() {
      current++;
      if (current < questions.length) {
        showQuestion();
      } else {
        finishQuiz();
      }
    }

    function finishQuiz() {
      const endTime = Date.now();
      const elapsedSec = Math.floor((endTime - startTime) / 1000);
      const initialScorePercent = Math.round((score / (score + incorrect)) * 100);

      if (firstAttemptScore === null) {
        firstAttemptScore = initialScorePercent;
        localStorage.setItem(`${username}_vocab_score`, initialScorePercent);
      }

      if (incorrectQuestions.length === 0) {
        container.innerHTML = `<h2>🎉 Perfect! Quiz complete!</h2>`;
        resultBox.textContent = `Score: ${firstAttemptScore}%, Time: ${elapsedSec} sec`;

        localStorage.setItem(`${username}_vocab_time`, elapsedSec);

        let ranking = JSON.parse(localStorage.getItem("vocab_ranking") || "[]");
        ranking.push({ name: username, score: firstAttemptScore, time: elapsedSec });
        localStorage.setItem("vocab_ranking", JSON.stringify(ranking));

        setTimeout(() => {
          window.location.href = "l3.html";
        }, 2000);
      } else {
        // 間違えた問題だけで再試行
        alert(`You missed ${incorrectQuestions.length} question(s). Let's try again.`);
        questions = [...incorrectQuestions];
        incorrectQuestions = [];
        current = 0;
        score = 0;
        incorrect = 0;
        startTime = Date.now();
        showQuestion();
      }
    }

    showQuestion();
  </script>
</body>
</html>
