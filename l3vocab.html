<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>L.3 - Vocabulary Quiz</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>L.3 - Vocabulary Course</h1>
  <p id="usernameDisplay"></p>

  <div id="quiz-container"></div>
  <button id="nextBtn" style="display:none;">Next</button>
  <p id="result"></p>

  <script type="module">
    const username = localStorage.getItem("username") || "Guest";
    document.getElementById("usernameDisplay").textContent = `Logged in as: ${username}`;

    const allQuestions = [
      { question: "Choose the correct meaning of 'wrap'", options: ["ï½ã‚’å–ã‚Šæ›¿ãˆã‚‹", "ï½ã‚’åŒ…ã‚€", "ï½ã‚’æŠ•ã’ã‚‹", "ï½ã‚’è‚²ã¦ã‚‹"], answer: 1 },
      { question: "Choose the correct meaning of 'individually'", options: ["æ€¥ã«", "ç°¡å˜ã«", "å€‹ã€…ã«", "å„ªã—ã"], answer: 2 },
      { question: "Choose the correct meaning of 'consideration'", options: ["è¨ˆç”»", "æ¤œæŸ»", "æ€ã„ã‚„ã‚Š", "æ³¨æ–‡"], answer: 2 },
      { question: "Choose the correct meaning of 'storage'", options: ["é‹æ¬", "å†åˆ©ç”¨", "ä¿ç®¡", "è²¯é‡‘"], answer: 2 },
      { question: "Choose the correct meaning of 'banquet'", options: ["ä¼‘æ†©", "ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼", "å®´", "ãŠè“å­"], answer: 2 },
      { question: "Choose the correct meaning of 'thoughtfulness'", options: ["æ€ã„ã‚„ã‚Š", "å¹¸é‹", "æº€è¶³", "èª¤è§£"], answer: 0 },
      { question: "Choose the correct meaning of 'impolite'", options: ["å‹‡æ•¢ãª", "æ¥½ã—ã„", "ç´ æ—©ã„", "ç„¡ä½œæ³•ãª"], answer: 3 },
      { question: "Choose the correct meaning of 'warm-hearted'", options: ["ãŠã—ã‚ƒã¹ã‚Šãª", "è¦ªåˆ‡ãª", "å†·ãŸã„", "è½ã¡ç€ã„ãŸ"], answer: 1 },
      { question: "Choose the correct meaning of 'unwrap'", options: ["ã€œã‚’åˆ‡ã‚‹", "ã€œã‚’é–‹å°ã™ã‚‹", "ã€œã‚’å£Šã™", "ã€œã‚’æ¨ã¦ã‚‹"], answer: 1 },
      { question: "Choose the correct meaning of 'growing'", options: ["å¢—å¤§ã™ã‚‹", "æ¸›ã£ã¦ã„ã‚‹", "è½ã¡ã¦ã„ã‚‹", "å›ºã¾ã£ã¦ã„ã‚‹"], answer: 0 },
      { question: "Choose the correct meaning of 'restrict'", options: ["ã€œã‚’ä¿ƒã™", "ã€œã‚’å»¶é•·ã™ã‚‹", "ã€œã‚’æ¥½ã—ã‚€", "ã€œã‚’åˆ¶é™ã™ã‚‹"], answer: 3 },
      { question: "Choose the correct meaning of 'ban'", options: ["ã€œã‚’ç¦æ­¢ã™ã‚‹", "ã€œã‚’ç¥ã†", "ã€œã‚’ä¿å­˜ã™ã‚‹", "ã€œã‚’å¥¨åŠ±ã™ã‚‹"], answer: 0 }
    ];

    function shuffle(array) {
      return array
        .map(value => ({ value, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ value }) => value);
    }

    let questions = [];
    let current = 0;
    let incorrectQuestions = [];
    let score = 0;
    let incorrect = 0;
    let firstAttemptScore = null;
    let startTime = Date.now();
    let answered = false;
    let perfectAchieved = false;
    let perfectTimeSec = 0;

    const container = document.getElementById("quiz-container");
    const resultBox = document.getElementById("result");
    const nextBtn = document.getElementById("nextBtn");

    nextBtn.addEventListener("click", () => nextQuestion());

    function startQuiz() {
      questions = shuffle([...allQuestions]);
      current = 0;
      score = 0;
      incorrect = 0;
      incorrectQuestions = [];
      startTime = Date.now();
      showQuestion();
    }

    function showQuestion() {
      answered = false;
      const q = questions[current];

      const originalOptions = q.options.map((opt, i) => ({
        text: opt,
        isCorrect: i === q.answer
      }));
      const shuffledOptions = shuffle(originalOptions);

      container.innerHTML = `
        <div class="question">
          <strong>Q${current + 1}: ${q.question}</strong><br>
          ${shuffledOptions.map((opt) =>
            `<button data-correct="${opt.isCorrect}" class="option-button">${opt.text}</button>`
          ).join("")}
        </div>
      `;

      resultBox.textContent = "";
      nextBtn.style.display = "none";

      document.querySelectorAll(".option-button").forEach(button => {
        button.addEventListener("click", () => {
          if (answered) return;
          answered = true;

          const isCorrect = button.dataset.correct === "true";
          if (isCorrect) {
            score++;
            resultBox.textContent = "âœ… Correct!";
          } else {
            incorrect++;
            resultBox.textContent = "âŒ Incorrect.";
            incorrectQuestions.push(q);
          }

          document.querySelectorAll(".option-button").forEach(btn => btn.disabled = true);
          nextBtn.style.display = "inline-block";
        });
      });
    }

    function nextQuestion() {
      current++;
      if (current < questions.length) {
        showQuestion();
      } else {
        finishQuiz();
      }
    }

    function finishQuiz() {
      const now = Date.now();
      const elapsedSec = Math.floor((now - startTime) / 1000);
      const initialScorePercent = Math.round((score / (score + incorrect)) * 100);

      if (firstAttemptScore === null) {
        firstAttemptScore = initialScorePercent;
        localStorage.setItem(`${username}_vocab_score`, initialScorePercent);
      }

      if (incorrectQuestions.length === 0) {
        if (!perfectAchieved) {
          perfectAchieved = true;
          perfectTimeSec = elapsedSec;

          localStorage.setItem(`${username}_vocab_time`, perfectTimeSec);

          let ranking = JSON.parse(localStorage.getItem("vocab_ranking") || "[]");
          ranking.push({ name: username, score: firstAttemptScore, time: perfectTimeSec });
          localStorage.setItem("vocab_ranking", JSON.stringify(ranking));
        }

        container.innerHTML = `<h2>ğŸ‰ Perfect! Quiz complete!</h2>`;
        resultBox.textContent = `Score: ${firstAttemptScore}%, Time: ${perfectTimeSec} sec`;

        setTimeout(() => {
          window.location.href = "l3.html";
        }, 2000);
      } else {
        alert(`You missed ${incorrectQuestions.length} question(s). Let's try again.`);
        questions = shuffle([...incorrectQuestions]);
        incorrectQuestions = [];
        current = 0;
        score = 0;
        incorrect = 0;
        startTime = Date.now();
        showQuestion();
      }
    }

    startQuiz(); // âœ… æœ€åˆã«å‘¼ã³å‡ºã—
  </script>
</body>
</html>
