<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>L.3 - Vocabulary & Listening</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h1>L.3 - Vocabulary & Listening</h1>
  <p id="usernameDisplay"></p>

  <!-- Vocabulary Quiz Section -->
  <section id="vocab-quiz-section">
    <div id="quiz-container"></div>
    <button id="nextBtn" style="display:none;">Next</button>
    <p id="result"></p>
  </section>

  <!-- Listening Quiz Section -->
  <section id="listening-quiz-section" style="display:none;">
    <div id="listening-container"></div>
    <input id="dictationInput" type="text" placeholder="Type the missing word...">
    <button id="replayAudio">🔈</button>
    <button id="checkDictation">Check</button>
    <p id="dictationResult"></p>
  </section>

<script>
let voices = [];
window.speechSynthesis.onvoiceschanged = () => {
  voices = speechSynthesis.getVoices();
};

function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  // "Samantha" を優先（iOS・Macによくある英語音声）
  const englishVoice = voices.find(voice => voice.lang === "en-US" && voice.name.includes("Samantha")) ||
                       voices.find(voice => voice.lang === "en-US");

  if (englishVoice) {
    utter.voice = englishVoice;
  } else {
    utter.lang = "en-US"; // fallback用
  }

  speechSynthesis.speak(utter);
}

const username = localStorage.getItem("username") || "Guest";
document.getElementById("usernameDisplay").textContent = `Logged in as: ${username}`;

function shuffle(array) {
  return array.map(value => ({ value, sort: Math.random() }))
              .sort((a, b) => a.sort - b.sort)
              .map(({ value }) => value);
}

// ---------------- Vocabulary Quiz ----------------
const allVocabQuestions = [
{ question: "Choose the correct meaning of 'wrap'", options: ["～を取り替える", "～を包む", "～を投げる", "～を育てる"], answer: 1 },
 { question: "Choose the correct meaning of 'individually'", options: ["急に", "簡単に", "個々に", "優しく"], answer: 2 },
 { question: "Choose the correct meaning of 'consideration'", options: ["計画", "検査", "思いやり", "注文"], answer: 2 },
 { question: "Choose the correct meaning of 'storage'", options: ["運搬", "再利用", "保管", "貯金"], answer: 2 },
 { question: "Choose the correct meaning of 'banquet'", options: ["休憩", "パーティー", "宴", "お菓子"], answer: 2 },
 { question: "Choose the correct meaning of 'thoughtfulness'", options: ["思いやり", "幸運", "満足", "誤解"], answer: 0 },
 { question: "Choose the correct meaning of 'impolite'", options: ["勇敢な", "楽しい", "素早い", "無作法な"], answer: 3 },
 { question: "Choose the correct meaning of 'warm-hearted'", options: ["おしゃべりな", "親切な", "冷たい", "落ち着いた"], answer: 1 },
 { question: "Choose the correct meaning of 'unwrap'", options: ["〜を切る", "〜を開封する", "〜を壊す", "〜を捨てる"], answer: 1 },
 { question: "Choose the correct meaning of 'growing'", options: ["増大する", "減っている", "落ちている", "固まっている"], answer: 0 },
 { question: "Choose the correct meaning of 'restrict'", options: ["〜を促す", "〜を延長する", "〜を楽しむ", "〜を制限する"], answer: 3 },
 { question: "Choose the correct meaning of 'ban'", options: ["〜を禁止する", "〜を祝う", "〜を保存する", "〜を奨励する"], answer: 0 }
];
let vocabQuestions = shuffle([...allVocabQuestions]);
let current = 0;
let incorrectQuestions = [];
let score = 0, incorrect = 0, answered = false;
let startTime = Date.now();
let firstAttemptScore = null;
let perfectAchieved = false;
let perfectTimeSec = 0;

const container = document.getElementById("quiz-container");
const resultBox = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");

nextBtn.addEventListener("click", nextQuestion);

function showVocabQuestion() {
  answered = false;
  const q = vocabQuestions[current];
  const shuffledOptions = shuffle(q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.answer })));

  container.innerHTML = `
    <div class="question">
      <strong>Q${current + 1}: ${q.question}</strong><br>
      ${shuffledOptions.map(opt => `<button data-correct="${opt.isCorrect}" class="option-button">${opt.text}</button>`).join('')}
    </div>
  `;

  resultBox.textContent = "";
  nextBtn.style.display = "none";

  document.querySelectorAll(".option-button").forEach(button => {
    button.addEventListener("click", () => {
      if (answered) return;
      answered = true;
      const isCorrect = button.dataset.correct === "true";
      if (isCorrect) {
        score++;
        resultBox.textContent = "✅ Correct!";
      } else {
        incorrect++;
        resultBox.textContent = "❌ Incorrect.";
        incorrectQuestions.push(q);
      }
      document.querySelectorAll(".option-button").forEach(btn => btn.disabled = true);
      nextBtn.style.display = "inline-block";
    });
  });
}

function nextQuestion() {
  current++;
  if (current < vocabQuestions.length) {
    showVocabQuestion();
  } else {
    finishVocabQuiz();
  }
}

function finishVocabQuiz() {
  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  const initialScorePercent = Math.round((score / (score + incorrect)) * 100);
  if (firstAttemptScore === null) {
    firstAttemptScore = initialScorePercent;
    localStorage.setItem(`${username}_vocab_score`, initialScorePercent);
  }
  if (incorrectQuestions.length === 0) {
    if (!perfectAchieved) {
      perfectAchieved = true;
      perfectTimeSec = elapsedSec;
      localStorage.setItem(`${username}_vocab_time`, perfectTimeSec);
    }
    document.getElementById("vocab-quiz-section").style.display = "none";
    startListeningQuiz();
  } else {
    alert("Some answers were wrong. Retrying those questions.");
    vocabQuestions = shuffle([...incorrectQuestions]);
    incorrectQuestions = [];
    current = 0;
    score = 0;
    incorrect = 0;
    startTime = Date.now();
    showVocabQuestion();
  }
}

// ---------------- Listening Quiz ----------------
let allListeningQuestions = [
  {
    sentence: "She used colorful paper to wrap the present.",
    display: "She used colorful paper to ______ the present.",
    answer: "wrap"
  },
  {
    sentence: "Each cookie was individually wrapped to keep it fresh.",
    display: "Each cookie was ______ wrapped to keep it fresh.",
    answer: "individually"
  },
  {
    sentence: "The documents were placed in a safe storage area.",
    display: "The documents were placed in a safe _____ area.",
    answer: "storage"
  },
  {
    sentence: "He showed great consideration for her feelings.",
    display: "He showed great ______ for her feelings.",
    answer: "consideration"
  },
  {
    sentence: "Her thoughtfulness made everyone feel welcome.",
    display: "Her _____ made everyone feel welcome.",
    answer: "thoughtfulness"
  },
  {
    sentence: "The wedding banquet was held in a large hall.",
    display: "The wedding _____ was held in a large hall.",
    answer: "banquet"
  },
  {
    sentence: "It is impolite to talk during a performance.",
    display: "It is _____ to talk during a performance.",
    answer: "impolite"
  },
  {
    sentence: "Please unwrap the gift carefully.",
    display: "Please _____ the gift carefully.",
    answer: "unwrap"
  },
  {
    sentence: "He is known for being warm-hearted and generous.",
    display: "He is known for being _____ and generous.",
    answer: "warm-hearted"
  },
  {
    sentence: "There is a growing interest in renewable energy.",
    display: "There is a _____ interest in renewable energy.",
    answer: "growing"
  },
  {
    sentence: "The school decided to restrict phone usage during classes.",
    display: "The school decided to _____ phone usage during classes.",
    answer: "restrict"
  },
  {
    sentence: "Smoking is banned in all public buildings.",
    display: "Smoking is _____ in all public buildings.",
    answer: "banned"
  }
];
let listeningQuestions = shuffle([...allListeningQuestions]);
let currentListening = 0;
let incorrectListeningQuestions = [];
let listeningStartTime;

function startListeningQuiz() {
  listeningQuestions = shuffle([...allListeningQuestions]);
  incorrectListeningQuestions = [];
  currentListening = 0;
  listeningStartTime = Date.now();
  document.getElementById("listening-quiz-section").style.display = "block";
  showListeningQuestion();
}

function showListeningQuestion() {
  const q = listeningQuestions[currentListening];
  document.getElementById("listening-container").textContent = `Q${currentListening + 1}: ${q.display}`;
  document.getElementById("dictationInput").value = "";
  document.getElementById("dictationResult").textContent = "";
  speak(q.sentence);
}

document.getElementById("replayAudio").addEventListener("click", () => {
  speak(listeningQuestions[currentListening].sentence);
});

document.getElementById("checkDictation").addEventListener("click", () => {
  const input = document.getElementById("dictationInput").value.trim().toLowerCase();
  const correct = listeningQuestions[currentListening].answer.toLowerCase();

  if (input === correct) {
    document.getElementById("dictationResult").textContent = "✅ Correct!";
    currentListening++;

    if (currentListening < listeningQuestions.length) {
      setTimeout(showListeningQuestion, 1000);
    } else if (incorrectListeningQuestions.length > 0) {
      alert("Retrying incorrect questions.");
      listeningQuestions = shuffle([...incorrectListeningQuestions]);
      incorrectListeningQuestions = [];
      currentListening = 0;
      setTimeout(showListeningQuestion, 1000);
    } else {
      const listeningTime = Math.floor((Date.now() - listeningStartTime) / 1000);
      const vocabTime = parseInt(localStorage.getItem(`${username}_vocab_time`) || "0");
      localStorage.setItem(`${username}_listening_time`, listeningTime);
      localStorage.setItem(`${username}_total_time`, vocabTime + listeningTime);
      document.getElementById("dictationResult").textContent = "🎉 Perfect! Listening quiz complete!";
      setTimeout(() => window.location.href = "l3.html", 2000);
    }
  } else {
    document.getElementById("dictationResult").textContent = "❌ Incorrect. Try again.";
    incorrectListeningQuestions.push(listeningQuestions[currentListening]);
    currentListening++;

    if (currentListening < listeningQuestions.length) {
      setTimeout(showListeningQuestion, 1000);
    } else {
      alert("Retrying incorrect answers.");
      listeningQuestions = shuffle([...incorrectListeningQuestions]);
      incorrectListeningQuestions = [];
      currentListening = 0;
      setTimeout(showListeningQuestion, 1000);
    }
  }
});
  // Enterキーでもチェックできるようにする
document.getElementById("dictationInput").addEventListener("keypress", function (e) {
  if (e.key === "Enter") {
    document.getElementById("checkDictation").click();
  }
});

showVocabQuestion();
</script>
</body>
</html>